name: Deploy to VPS

on:
  workflow_run:
    workflows: ["Docker Build & Push"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  verify-docker-build:
    name: Verify Docker Build Passed
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    steps:
      - name: Check Docker Build workflow conclusion
        if: github.event.workflow_run.conclusion != 'success'
        run: |
          echo "❌ Docker Build workflow failed or was cancelled. Skipping deployment."
          exit 1

      - name: Docker Build passed
        run: echo "✅ Docker Build workflow passed. Proceeding with deployment."

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [verify-docker-build]
    if: |
      always() &&
      (needs.verify-docker-build.result == 'success' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          APP_DIR: ${{ secrets.APP_DIR || '/var/www/chat-app' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'EOF'
            set -e

            # Navigate to app directory
            cd ${{ secrets.APP_DIR || '/var/www/chat-app' }}

            echo "=== Starting deployment ==="
            echo "Timestamp: $(date)"

            # Pull latest code (for docker-compose.yml and .env)
            echo "[1/5] Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # Login to GitHub Container Registry
            echo "[2/5] Logging in to GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest images (use COMPOSE_IMAGE_MODE=pull to skip building)
            echo "[3/5] Pulling latest Docker images..."
            COMPOSE_IMAGE_MODE=pull docker compose pull

            # Run database migrations (before restarting services)
            echo "[4/5] Running database migrations..."
            COMPOSE_IMAGE_MODE=pull docker compose run --rm backend pnpm db:migrate

            # Restart services with new images
            echo "[5/5] Restarting services..."
            COMPOSE_IMAGE_MODE=pull docker compose up -d

            # Health check
            echo "Waiting 10 seconds for backend to start..."
            sleep 10

            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/health || echo "000")

            if [ "$HEALTH_STATUS" = "200" ]; then
              echo "✅ Deployment successful! Backend health check passed."
            else
              echo "❌ Warning: Backend health check failed (status: $HEALTH_STATUS)"
              echo "Check logs: COMPOSE_IMAGE_MODE=pull docker compose logs backend"
              exit 1
            fi

            echo "=== Deployment completed at: $(date) ==="
            COMPOSE_IMAGE_MODE=pull docker compose ps
          EOF

      - name: Deployment status notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment to VPS successful!"
          else
            echo "❌ Deployment to VPS failed!"
            exit 1
          fi

  rollback:
    name: Rollback (Manual Trigger Only)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    # This job should only be triggered manually when needed

    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Rollback deployment
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          APP_DIR: ${{ secrets.APP_DIR || '/var/www/chat-app' }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'EOF'
            set -e

            cd ${{ secrets.APP_DIR || '/var/www/chat-app' }}

            echo "=== Starting rollback ==="

            # List available image tags
            echo "Available image versions:"
            docker images ghcr.io/${{ github.repository }}/backend --format "{{.Tag}}"

            # Prompt user to specify which version to rollback to
            # For automated rollback, you can set a specific tag like 'main-<previous-sha>'
            echo "To rollback, set IMAGE_TAG environment variable and restart:"
            echo "IMAGE_TAG=main-abc123 COMPOSE_IMAGE_MODE=pull docker compose up -d"
            echo ""
            echo "Or add to .env file:"
            echo "  COMPOSE_IMAGE_MODE=pull"
            echo "  IMAGE_TAG=main-abc123"
            echo "Then run: docker compose up -d"
            echo ""
            echo "Note: This rollback job is informational. Implement version-specific rollback as needed."

            echo "✅ Rollback instructions displayed"
          EOF
